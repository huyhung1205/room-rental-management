@model Project_65133295.Areas.Admin.Data.RoomFormViewModel_65133295

@{
    ViewBag.Title = "Edit Room";
    ViewBag.PageTitle = "Edit Room";
    ViewBag.PageDescription = "Update detailed room information";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="max-w-5xl mx-auto pb-20">
    @using (Html.BeginForm("EditRoom", "Admin_65133295", FormMethod.Post, new { enctype = "multipart/form-data", id = "roomForm" }))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.RoomID)
        
        if (!ViewData.ModelState.IsValid)
        {
            @Html.ValidationSummary(false, "", new { @class = "mb-6 p-4 bg-red-50 border-l-4 border-red-400 text-red-700 rounded-xl text-sm font-medium shadow-sm" })
        }

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Basic Info -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <span class="w-8 h-8 bg-yellow-100 text-primary-dark rounded-lg flex items-center justify-center mr-3 text-sm">01</span>
                        Basic Information
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">Room Number <span class="text-red-500">*</span></label>
                            @Html.TextBoxFor(m => m.RoomNumber, new { @class = "block w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed transition-all", @readonly = "readonly" })
                            @Html.ValidationMessageFor(m => m.RoomNumber, "", new { @class = "text-xs text-red-500 font-medium" })
                        </div>
                        
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">Listing Title <span class="text-red-500">*</span></label>
                            @Html.TextBoxFor(m => m.Title, new { @class = "block w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-1 focus:ring-primary focus:border-primary transition-all" })
                            @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-xs text-red-500 font-medium" })
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">Monthly Rent (VND) <span class="text-red-500">*</span></label>
                            @Html.TextBox("Price", Model.Price.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture), new { @type = "number", @min = "0", @class = "block w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-1 focus:ring-primary focus:border-primary transition-all", placeholder = "E.g: 3500000" })
                            @Html.ValidationMessageFor(m => m.Price, "", new { @class = "text-xs text-red-500 font-medium" })
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">Area (m²) <span class="text-red-500">*</span></label>
                            @Html.TextBox("Area", Model.Area.HasValue ? Model.Area.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "", new { @type = "number", @step = "0.01", @min = "0", @class = "block w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-1 focus:ring-primary focus:border-primary transition-all", placeholder = "E.g: 25.5" })
                            @Html.ValidationMessageFor(m => m.Area, "", new { @class = "text-xs text-red-500 font-medium" })
                        </div>

                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-bold text-gray-700">Detailed Description</label>
                            @Html.TextAreaFor(m => m.Description, new { @class = "block w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-1 focus:ring-primary focus:border-primary transition-all min-h-[120px]" })
                        </div>
                    </div>
                </div>

                <!-- Utilities -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mr-3 text-sm">02</span>
                        Room Amenities
                    </h3>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        @for (int i = 0; i < Model.Utilities.Count; i++)
                        {
                            <label class="relative flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-white hover:border-primary cursor-pointer transition-all group">
                                @Html.HiddenFor(m => m.Utilities[i].UtilityID)
                                @Html.HiddenFor(m => m.Utilities[i].UtilityName)
                                @Html.CheckBoxFor(m => m.Utilities[i].IsSelected, new { @class = "w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary transition" })
                                <span class="ml-3 text-sm font-medium text-gray-700 group-hover:text-primary-dark">@Model.Utilities[i].UtilityName</span>
                            </label>
                        }
                    </div>
                </div>

                <!-- Images -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center mr-3 text-sm">03</span>
                        Current & New Images
                    </h3>
                    
                    <div class="space-y-6">
                        <!-- Existing Images -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="existingImagesList">
                            @if (Model.ExistingImages != null)
                            {
                                for (int i = 0; i < Model.ExistingImages.Count; i++)
                                {
                                <div class="relative h-28 rounded-lg overflow-hidden border border-gray-100 shadow-sm group" id="img-container-@i">
                                    @Html.HiddenFor(m => m.ExistingImages[i].ImageID)
                                    @Html.HiddenFor(m => m.ExistingImages[i].ImageURL)
                                    @Html.HiddenFor(m => m.ExistingImages[i].IsDeleted, new { @id = "isDeleted-" + i })
                                    <img src="@Model.ExistingImages[i].ImageURL" class="w-full h-full object-cover" id="img-@i" />
                                    <button type="button" onclick="markAsDeleted(@i)" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                    <div id="deleted-overlay-@i" class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden">
                                        <span class="text-white text-[10px] font-bold">SẼ XÓA</span>
                                        <button type="button" onclick="undoDeleted(@i)" class="ml-2 text-primary text-[10px] font-bold underline">Undo</button>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <!-- New Uploads -->
                        <div class="pt-4 border-t border-gray-100">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-200 rounded-2xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-all">
                                <div class="flex flex-col items-center justify-center py-4">
                                    <svg class="w-8 h-8 mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    <p class="text-xs text-gray-500 font-bold">Thêm ảnh mới</p>
                                </div>
                                <input type="file" name="NewImages" id="imageInput" multiple class="hidden" accept="image/*" />
                            </label>
                            <div id="newImagePreview" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Settings Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 sticky top-8">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-6">Update System Settings</h3>
                    
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">Current Status</label>
                            @Html.DropDownListFor(m => m.StatusID, new SelectList(Model.Statuses, "StatusID", "StatusName"), new { @class = "block w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-1 focus:ring-primary focus:border-primary appearance-none bg-no-repeat bg-[right_1rem_center] transition-all", style="background-image: url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 fill%3D%22none%22 viewBox%3D%220 0 20 20%22%3E%3Cpath stroke%3D%22%236b7280%22 stroke-linecap%3D%22round%22 stroke-linejoin%3D%22round%22 stroke-width%3D%221.5%22 d%3D%22m6 8 4 4 4-4%22%2F%3E%3C%2Fsvg%3E')" })
                            @Html.ValidationMessageFor(m => m.StatusID, "", new { @class = "text-xs text-red-500 font-medium" })
                        </div>

                        <div class="space-y-2 hidden">
                            <label class="text-sm font-bold text-gray-700">Building Location</label>
                            @Html.HiddenFor(m => m.AddressID)
                            @Html.ValidationMessageFor(m => m.AddressID, "", new { @class = "text-xs text-red-500 font-medium" })
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">Maximum Occupancy</label>
                            @Html.TextBoxFor(m => m.MaxOccupancy, new { @type = "number", @min = "0", @class = "block w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-1 focus:ring-primary focus:border-primary transition-all" })
                        </div>

                        <div class="pt-6 border-t border-gray-50 flex flex-col gap-3">
                            <button type="submit" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-bold text-white bg-primary hover:bg-primary-dark transition-all">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                Update Room
                            </button>
                            <a href="@Url.Action("ManageRooms")" class="w-full flex justify-center items-center py-3 px-4 border border-gray-200 rounded-xl text-sm font-bold text-gray-600 bg-white hover:bg-gray-50 transition-all">
                                Back to List
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section scripts {
    <script>
        function markAsDeleted(index) {
            document.getElementById('isDeleted-' + index).value = 'true';
            document.getElementById('deleted-overlay-' + index).classList.remove('hidden');
            document.getElementById('img-' + index).style.filter = 'grayscale(100%) blur(2px)';
        }

        function undoDeleted(index) {
            document.getElementById('isDeleted-' + index).value = 'false';
            document.getElementById('deleted-overlay-' + index).classList.add('hidden');
            document.getElementById('img-' + index).style.filter = 'none';
        }

        // New Image preview & management
        const imageInput = document.getElementById('imageInput');
        const newImagePreview = document.getElementById('newImagePreview');
        let selectedFiles = [];

        imageInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) return;
                
                selectedFiles.push(file);
                const reader = new FileReader();
                reader.onload = function(event) {
                    const div = document.createElement('div');
                    div.className = "relative h-24 rounded-lg overflow-hidden border border-gray-200 shadow-sm group";
                    div.id = `new-preview-${selectedFiles.length - 1}`;
                    div.innerHTML = `
                        <img src="${event.target.result}" class="w-full h-full object-cover" />
                        <button type="button" onclick="removeNewImage(${selectedFiles.length - 1})" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    newImagePreview.appendChild(div);
                    updateInputFiles();
                };
                reader.readAsDataURL(file);
            });
        });

        function removeNewImage(index) {
            selectedFiles[index] = null;
            document.getElementById(`new-preview-${index}`).remove();
            updateInputFiles();
        }

        function updateInputFiles() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => {
                if (file) dataTransfer.items.add(file);
            });
            imageInput.files = dataTransfer.files;
        }
    </script>
}
